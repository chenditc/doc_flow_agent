#############################
# Sandbox Image for Remote Job Execution
# Base: All-in-one sandbox runtime providing /v1 APIs on port 8080
#############################

FROM enterprise-public-cn-beijing.cr.volces.com/vefaas-public/all-in-one-sandbox:latest AS base

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    PYTHONPATH=/app

WORKDIR /app

# Copy requirements and install Python deps needed to run our job code
COPY requirements.txt ./
RUN pip install --no-cache-dir -r requirements.txt

# Copy repo contents into /app (working directory)
COPY . .

# Ensure expected directories exist for runner
RUN mkdir -p /app/traces /app/jobs /app/log /app/user_comm/ && chmod -R 777 /app/traces /app/jobs /app/log /app/user_comm/ 

# Expose sandbox API port
EXPOSE 8080

# NOTE: do NOT override the default CMD/ENTRYPOINT from the base image;
# the base image is expected to start the sandbox service on port 8080.
