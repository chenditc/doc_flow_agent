services:
  orchestrator:
    build:
      context: .
      dockerfile: Dockerfile.orchestrator
    image: docflow/orchestrator:latest
    env_file:
      - .env
    volumes:
      - traces:/app/traces
      - jobs:/app/jobs
      - log:/app/log
      - user_comm:/app/user_comm
      - embedding_cache:/app/embedding_cache
      # Mount .env read-only so code that reads file directly (if any) can access; env vars already loaded via env_file
      - type: bind
        source: ./.env
        target: /app/.env
        read_only: true
    expose:
      - "8001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 20s
    depends_on:
      sandbox:
        condition: service_started
    environment:
      # Inject default sandbox url so orchestrator always uses sandbox if present
      - DEFAULT_SANDBOX_URL=http://sandbox:8080

  visualization:
    build:
      context: .
      dockerfile: Dockerfile.visualization
    image: docflow/visualization:latest
    env_file:
      - .env
    environment:
      - ORCHESTRATOR_BASE_URL=http://orchestrator:8001
    volumes:
      - traces:/app/traces:ro
      - log:/app/log
      - user_comm:/app/user_comm
      - type: bind
        source: ./.env
        target: /app/.env
        read_only: true
    expose:
      - "8000"
    depends_on:
      orchestrator:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 20s

  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    image: docflow/frontend:latest
    depends_on:
      orchestrator:
        condition: service_healthy
      visualization:
        condition: service_healthy
    ports:
      - "28080:80"
    healthcheck:
      test: ["CMD", "wget", "-qO", "-", "http://localhost/healthz"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  sandbox:
    build:
      context: .
      dockerfile: Dockerfile.sandbox
    image: docflow/sandbox:latest
    ports:
      - "8080:8080"
    security_opt:
      - seccomp=unconfined
    env_file:
      - .env
    # The base image starts the sandbox server; no command override here
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/v1/sandbox"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 10s

volumes:
  traces:
  jobs:
  log:
  user_comm:
  embedding_cache:
