services:
  orchestrator:
    build:
      context: .
      dockerfile: Dockerfile.orchestrator
    image: docflow/orchestrator:latest
    env_file:
      - .env
    environment:
      - DEFAULT_WORKSPACE_SANDBOX_URL=http://default_workspace_sandbox:8080
    volumes:
      - traces:/app/traces
      - jobs:/app/jobs
      - log:/app/log
      - user_comm:/app/user_comm
      # Mount .env read-only so code that reads file directly (if any) can access; env vars already loaded via env_file
      - type: bind
        source: ./.env
        target: /app/.env
        read_only: true
    expose:
      - "8001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 20s
    depends_on:
      default_workspace_sandbox:
        condition: service_healthy

  visualization:
    build:
      context: .
      dockerfile: Dockerfile.visualization
    image: docflow/visualization:latest
    env_file:
      - .env
    environment:
      - DEFAULT_WORKSPACE_SANDBOX_URL=http://default_workspace_sandbox:8080
    volumes:
      - traces:/app/traces:ro
      - log:/app/log
      - user_comm:/app/user_comm
      - type: bind
        source: ./.env
        target: /app/.env
        read_only: true
    expose:
      - "8000"
    depends_on:
      orchestrator:
        condition: service_started
      default_workspace_sandbox:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 20s

  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    image: docflow/frontend:latest
    environment:
      - DEFAULT_WORKSPACE_SANDBOX_URL=http://default_workspace_sandbox:8080
    depends_on:
      orchestrator:
        condition: service_healthy
      visualization:
        condition: service_healthy
    ports:
      - "28080:80"
    healthcheck:
      test: ["CMD", "wget", "-qO", "-", "http://localhost/healthz"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  default_workspace_sandbox:
    image: ghcr.io/agent-infra/sandbox:latest
    security_opt:
      - seccomp=unconfined
    ports:
      - "8080:8080"
    expose:
      - "8080"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

volumes:
  traces:
  jobs:
  log:
  user_comm:
